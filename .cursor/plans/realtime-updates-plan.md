# План: Real-time оновлення гри

## Статус: В розробці

## Мета

Реалізувати push-оновлення стану гри для всіх гравців, які беруть участь у грі та знаходяться на сторінці гри.

---

## Що вже зроблено ✅

### Backend
- [x] `GameEventHub` - сервіс для керування SSE з'єднаннями
- [x] SSE endpoint `/api/leagues/{league}/wizard/games/{code}/events`
- [x] Broadcast після всіх операцій з грою (bids, results, complete, etc.)
- [x] Heartbeat кожні 30 секунд

### Frontend
- [x] `subscribeToEvents()` в WizardApi
- [x] Обробка подій в wizard store
- [x] Auto-reconnect при втраті з'єднання
- [x] UI індикатор "Live (N)" з кількістю підключених

### Документація
- [x] Технічна документація (REALTIME_UPDATES.md)
- [x] Практична документація українською (REALTIME_UPDATES.uk.md)

---

## Що потрібно обговорити / зробити

### 1. Оптимістичні оновлення (Optional)

**Проблема:** Зараз гравець, який вводить дані, чекає відповіді сервера. Інші гравці отримують оновлення швидше.

**Рішення:** 
- Показувати локальні зміни одразу
- Відкатувати при помилці

**Питання:** Чи потрібно це? Поточна швидкість достатня?

---

### 2. Конфлікти одночасного редагування

**Проблема:** Якщо двоє гравців одночасно введуть ставки - переможе останній.

**Можливі рішення:**

#### A) Блокування на рівні UI
- Показувати хто зараз редагує
- Блокувати кнопки для інших

#### B) Версіонування
- Додати `version` до гри
- Перевіряти версію при оновленні
- Повертати помилку якщо версія застаріла

#### C) Нічого не робити
- Прийняти що останній виграє
- Показувати оновлення в реальному часі

**Питання:** Який підхід обрати?

---

### 3. Нотифікації про дії інших гравців

**Ідея:** Показувати toast/notification коли інший гравець щось зробив.

**Приклади:**
- "Гравець X ввів ставки"
- "Модератор завершив раунд"
- "Гра фіналізована"

**Питання:** Чи потрібно? Які дії показувати?

---

### 4. Присутність гравців (Presence)

**Ідея:** Показувати список гравців, які зараз дивляться на гру.

**Реалізація:**
- Зберігати userId/membershipId при підписці
- Надсилати список при зміні

**UI:**
- Аватарки гравців онлайн
- Або просто список імен

**Питання:** Чи потрібно? Достатньо просто числа?

---

### 5. Розширення на інші ігри

**Поточний стан:** SSE тільки для Wizard

**Потрібно:**
- Узагальнити GameEventHub для всіх типів ігор
- Додати SSE endpoint для generic game rounds
- Оновити відповідні сторінки

**Питання:** Які ігри потребують real-time?

---

### 6. Масштабування (коли буде потрібно)

**Проблема:** Один instance = один hub. При горизонтальному масштабуванні SSE з різних instances не синхронізовані.

**Рішення:** Redis Pub/Sub
```
Instance 1 ──publish──▶ Redis ◀──subscribe── Instance 2
     │                                            │
     ▼                                            ▼
  Clients                                      Clients
```

**Питання:** Відкласти до реального навантаження?

---

### 7. Мобільна оптимізація

**Проблема:** SSE тримає з'єднання відкритим, що може впливати на батарею.

**Рішення:**
- Збільшити heartbeat interval на мобільних
- Або fallback до polling

**Питання:** Чи є проблема на практиці?

---

## Пріоритети (пропозиція)

| # | Задача | Пріоритет | Складність |
|---|--------|-----------|------------|
| 1 | Нотифікації про дії | Середній | Низька |
| 2 | Конфлікти редагування | Низький | Середня |
| 3 | Присутність гравців | Низький | Низька |
| 4 | Інші ігри | За потребою | Середня |
| 5 | Оптимістичні оновлення | Низький | Висока |
| 6 | Масштабування | За потребою | Висока |
| 7 | Мобільна оптимізація | За потребою | Середня |

---

## Наступні кроки

1. **Тестування** поточної реалізації в реальних умовах
2. **Збір feedback** від гравців
3. **Прийняття рішень** по кожному пункту вище

---

## Нотатки

_Додайте тут будь-які думки або коментарі_

