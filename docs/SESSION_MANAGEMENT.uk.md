# Керування сесіями та обліковими записами

## Огляд

Додаток board-games-league використовує гібридну систему аутентифікації на основі токенів з відстеженням сесій, геолокацією та діагностичними можливостями. Ця система забезпечує безпечне, масштабоване керування сесіями з токенами обертання та короткочасними токенами дії.

## Архітектура

### Система токенів

Система використовує підхід з двома токенами:

1. **Токен обертання** (Довгоживучий)
   - Зберігається в `localStorage` браузера (клієнтська сторона)
   - Зберігається в MongoDB (серверна сторона)
   - Тривалість: 30 днів
   - Інтервал обертання: Кожні 12 годин (коли токен дії оновлюється)
   - Призначення: Використовується тільки для оновлення токенів дії
   - Не відправляється з кожним запитом (зберігається в localStorage, не в cookies)

2. **Токен дії** (Короткочасний)
   - Зберігається в HTTP-only, Secure, SameSite cookie
   - Формат: JWT (JSON Web Token)
   - Тривалість: 1 година
   - Призначення: Використовується для аутентифікації API запитів
   - Автоматично оновлюється за допомогою токена обертання після закінчення терміну дії

### Потік токенів

```
┌─────────┐                ┌──────────┐                ┌─────────┐
│ Клієнт  │                │  Сервер  │                │   БД    │
└────┬────┘                └────┬─────┘                └────┬────┘
     │                          │                           │
     │  1. Запит входу          │                           │
     │─────────────────────────>│                           │
     │                          │                           │
     │                          │  2. Створити сесію        │
     │                          │──────────────────────────>│
     │                          │                           │
     │  3. Повернути rotateToken│                           │
     │     + Встановити actionToken│                        │
     │<─────────────────────────│                           │
     │                          │                           │
     │  4. Зберегти rotateToken │                           │
     │     в localStorage      │                           │
     │                          │                           │
     │  5. API запит            │                           │
     │     (з actionToken)      │                           │
     │─────────────────────────>│                           │
     │                          │  6. Перевірити JWT        │
     │  7. Відповідь            │                           │
     │<─────────────────────────│                           │
     │                          │                           │
     │  8. Токен дії закінчився │                           │
     │     (помилка 401)        │                           │
     │<─────────────────────────│                           │
     │                          │                           │
     │  9. Запит оновлення      │                           │
     │     (Authorization:      │                           │
     │      Bearer rotateToken) │                           │
     │─────────────────────────>│                           │
     │                          │  10. Перевірити rotateToken│
     │                          │──────────────────────────>│
     │                          │                           │
     │                          │  11. Обернути якщо потрібно│
     │                          │──────────────────────────>│
     │  12. Новий actionToken   │                           │
     │      + Новий rotateToken │                           │
     │      (якщо обернуто)    │                           │
     │<─────────────────────────│                           │
```

## Компоненти

### Серверні компоненти

#### Моделі

**Модель Session** (`backend/models/session.go`)
- Зберігає інформацію про сесію в MongoDB
- Поля:
  - `RotateToken`: Унікальний ідентифікатор токена
  - `UserID`: Посилання на користувача
  - `CreatedAt`, `UpdatedAt`, `LastRotationAt`: Мітки часу
  - `ExpiresAt`: Завершення сесії (30 днів)
  - `IPAddress`, `UserAgent`: Відстеження запитів
  - `Version`: Оптимістичне блокування для конкурентних оновлень

**Модель User** (`backend/models/user.go`)
- Розширена полем `LastActivity` для відстеження активності користувача

**Модель GeoIPInfo** (`backend/models/geoip.go`)
- Зберігає інформацію про геолокацію
- Поля: Країна, Регіон, Місто, Часовий пояс, ISP тощо

#### Сервіси

**SessionService** (`backend/services/session_service.go`)
- `CreateSession()`: Створює нову сесію з токенами обертання та дії
- `RefreshActionToken()`: Оновлює токен дії, обертає токен обертання якщо потрібно (інтервал 12 год)
- `InvalidateSession()`: Видаляє сесію (вихід)
- `CleanupExpiredSessions()`: Видаляє застарілі сесії (фонова задача)

**RequestService** (`backend/services/request_service.go`)
- `GetClientIP()`: Витягує IP адресу клієнта з заголовків (X-Forwarded-For, X-Real-IP, RemoteAddr)
- `BuildBaseURL()`: Формує базовий URL з протоколу та хосту запиту
- `IsTrustedOrigin()`: Перевіряє походження запиту проти списку довірених джерел

**GeoIPService** (`backend/services/geoip_service.go`)
- `GetGeoIPInfo()`: Визначає географічну інформацію за IP адресою
- Використовує API ipapi.co (безкоштовний рівень, API ключ не потрібен)
- Повертає країну, регіон, місто, часовий пояс, інформацію про ISP

#### Репозиторії

**SessionRepository** (`backend/repositories/session_repository.go`)
- Операції MongoDB для сесій
- Індекси: `rotate_token` (унікальний), `user_id`, `expires_at`
- Методи: Create, FindByRotateToken, FindByUserID, Update, Delete, DeleteExpired

#### API точки доступу

**Точки доступу аутентифікації**

- `POST /api/auth/google/callback`
  - Callback Google OAuth
  - Створює сесію
  - Повертає дані користувача + `rotateToken` (для localStorage)
  - Встановлює cookie `actionToken`

- `POST /api/auth/refresh`
  - Оновлює токен дії
  - Запит: `Authorization: Bearer <rotateToken>`
  - Відповідь: Новий cookie `actionToken` + опціональний `rotateToken` (якщо обернуто)
  - Повертає JSON: `{rotateToken?: string}`

- `POST /api/auth/logout`
  - Деактивує сесію
  - Приймає `rotateToken` в тілі запиту або заголовку Authorization
  - Очищує cookie токена дії
  - Очищає rotateToken з localStorage (клієнтська сторона)

**Користувацькі точки доступу**

- `GET /api/user/sessions`
  - Повертає всі активні сесії поточного користувача
  - Параметр запиту: `?current=<rotateToken>` (опціональний, позначає поточну сесію)
  - Відповідь: Масив інформації про сесії з геолокацією

**Адміністративні точки доступу**

- `GET /api/admin/diagnostics`
  - Точка доступу тільки для адмінів
  - Повертає інформацію про сервер, запит та геолокацію
  - Потребує прав супер-адміністратора

### Клієнтські компоненти

#### API клієнти

**UserApi** (`frontend/src/api/UserApi.ts`)
- `getUserSessions(currentRotateToken?)`: Отримує сесії користувача

**DiagnosticsApi** (`frontend/src/api/DiagnosticsApi.ts`)
- `getDiagnostics()`: Отримує діагностичну інформацію (тільки для адмінів)

**Auth** (`frontend/src/api/Auth.ts`)
- Оновлено для збереження `rotateToken` в localStorage після входу

#### Види

**UserView** (`frontend/src/views/UserView.vue`)
- Відображає профіль користувача
- Показує таблицю активних сесій з:
  - Місцем розташування (місто, країна)
  - IP адресою
  - User agent
  - Міткою часу створення
  - Останньою активністю
  - Індикатором поточної сесії

**DiagnosticsView** (`frontend/src/views/DiagnosticsView.vue`)
- Сторінка тільки для адмінів
- Відображає:
  - Інформацію про сервер (host URL, довірені джерела)
  - Інформацію про запит (IP, базовий URL, походження, статус довіри)
  - Інформацію про геолокацію

## Конфігурація

### Змінні середовища

**Обов'язкові**
- `MONGODB_URI`: Рядок підключення до MongoDB
- `GOOGLE_CLIENT_ID`: Client ID Google OAuth
- `GOOGLE_CLIENT_SECRET`: Client Secret Google OAuth
- `JWT_SECRET`: Секретний ключ для підпису JWT токенів
- `SESSION_SECRET`: Секретний ключ для cookies сесій
- `SUPERADMINS`: Список зовнішніх ID (email) супер-адміністраторів через кому

**Опціональні**
- `TRUSTED_ORIGINS`: Список довірених джерел через кому для валідації CORS
- `HOST_URL`: Базовий URL додатку (автоматично визначається якщо не встановлено)

### База даних

Система створює нову колекцію MongoDB: `sessions`

Створені індекси:
- `rotate_token` (унікальний)
- `user_id`
- `expires_at`

### Тривалість життя токенів

- **Токен дії**: 1 година (налаштовується в `user_profile.CreateAuthTokenWithExpiry`)
- **Токен обертання**: Обертається кожні 12 годин, закінчується через 30 днів

## Використання

### Потік користувача

1. **Вхід**
   - Користувач натискає вхід → перенаправлення на Google OAuth
   - Після аутентифікації callback створює сесію
   - `rotateToken` зберігається в localStorage
   - `actionToken` встановлюється як HTTP-only cookie

2. **Виконання запитів**
   - Клієнт відправляє запити з cookie `actionToken` автоматично
   - Middleware перевіряє токен
   - Якщо закінчився, клієнт отримує 401

3. **Оновлення токена**
   - Клієнт виявляє помилку 401
   - Викликає `/api/auth/refresh` з `rotateToken` з localStorage
   - Отримує новий cookie `actionToken`
   - Отримує новий `rotateToken` якщо відбулося обертання (оновлює localStorage)

4. **Перегляд сесій**
   - Користувач переходить на сторінку профілю
   - Таблиця сесій показує всі активні сесії
   - Поточна сесія виділяється

5. **Вихід**
   - Клієнт викликає `/api/auth/logout` з `rotateToken`
   - Сервер деактивує сесію
   - Клієнт видаляє `rotateToken` з localStorage
   - Cookie очищається сервером

### Потік адміністратора

1. **Доступ до діагностики**
   - Адмін переходить до `/ui/admin/diagnostics`
   - Система відображає діагностичну інформацію
   - Неадміни отримують 403 Forbidden

### Потік розробника

#### Додавання нових захищених маршрутів

```go
r.Group(func(r chi.Router) {
    r.Use(authHandler.Middleware)
    r.Get("/your-route", yourHandler)
})
```

#### Доступ до користувача в обробнику

```go
profile, ok := r.Context().Value("user").(*user_profile.UserProfile)
if !ok || profile == nil {
    // Обробити неавторизований доступ
}
```

#### Перевірка статусу адміна

```go
if !auth.IsSuperAdmin(profile.ExternalIDs) {
    // Обробити неавторизований доступ
}
```

## Функції безпеки

1. **HTTP-Only Cookies**: Токени дії зберігаються в HTTP-only cookies запобігають XSS атакам
2. **Secure Cookies**: Cookies позначені як Secure (тільки HTTPS)
3. **SameSite Strict**: Запобігає CSRF атакам
4. **Обертання токенів**: Токени обертання обертаються кожні 12 годин
5. **Завершення сесій**: Сесії закінчуються через 30 днів
6. **Оптимістичне блокування**: Запобігає гонкам під час обертання токенів
7. **Відстеження IP**: Сесії відстежують IP адреси для моніторингу безпеки
8. **Довірені джерела**: Опціональна валідація походження для CORS

## Фонові завдання

**Очищення сесій**
- Запускається кожну 1 годину
- Видаляє застарілі сесії з бази даних
- Логує активність очищення

## Геолокація

Система використовує API ipapi.co для геолокації (безкоштовний рівень):
- API ключ не потрібен
- Застосовуються обмеження швидкості (перевірте документацію ipapi.co)
- Gracefully відступає якщо сервіс недоступний
- Інформація про геолокацію опціональна та неблокуюча

## Усунення проблем

### Сесія не працює

1. Перевірте що `rotateToken` збережено в localStorage
2. Переконайтеся що cookie `actionToken` встановлено (перевірте DevTools браузера)
3. Перевірте логи сервера на помилки аутентифікації
4. Переконайтеся що JWT_SECRET встановлено правильно

### Геолокація не відображається

1. Перевірте підключення до інтернету (сервіс використовує зовнішній API)
2. Переконайтеся що сервіс ipapi.co доступний
3. Перевірте обмеження швидкості на ipapi.co
4. Інформація про геолокацію опціональна - сесії працюють без неї

### Доступ адміна заборонено

1. Переконайтеся що зовнішній ID користувача в `SUPERADMINS` змінній середовища
2. Перевірте що зовнішні ID точно збігаються (чутливо до регістру)
3. Користувач повинен повторно автентифікуватися після додавання до SUPERADMINS

## Примітки про міграцію

### Зі старої системи

- Старі JWT токени будуть недійсними після розгортання
- Користувачі повинні повторно автентифікуватися
- Міграція бази даних не потрібна (нова колекція)
- Існуючі дані користувачів збережені

### Зворотна сумісність

- Старі точки доступу аутентифікації замінені
- Frontend повинен бути оновлено для використання нової системи токенів
- Інформація про сесії - нова функція (зворотно сумісна)

## Приклади API

### Оновлення токена

```bash
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Authorization: Bearer <rotateToken>" \
  -H "Cookie: auth_token=<old_action_token>"
```

Відповідь:
```json
{
  "rotateToken": "new_rotate_token_if_rotated"
}
```

### Отримання сесій користувача

```bash
curl http://localhost:8080/api/user/sessions?current=<rotateToken> \
  -H "Cookie: auth_token=<action_token>"
```

Відповідь:
```json
[
  {
    "rotate_token": "...",
    "ip_address": "192.168.1.1",
    "user_agent": "Mozilla/5.0...",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T12:00:00Z",
    "last_rotation_at": "2024-01-01T12:00:00Z",
    "expires_at": "2024-01-31T00:00:00Z",
    "is_current": true,
    "geo_info": {
      "country": "United States",
      "city": "New York",
      "region": "NY",
      "timezone": "America/New_York"
    }
  }
]
```

### Діагностика (Тільки для адмінів)

```bash
curl http://localhost:8080/api/admin/diagnostics \
  -H "Cookie: auth_token=<action_token>"
```

Відповідь:
```json
{
  "server_info": {
    "host_url": "http://localhost:8080",
    "trusted_origins": ["http://localhost:3000"]
  },
  "request_info": {
    "ip_address": "192.168.1.1",
    "base_url": "http://localhost:8080",
    "user_agent": "Mozilla/5.0...",
    "origin": "http://localhost:3000",
    "is_trusted": true,
    "geo_info": {
      "country": "United States",
      "city": "New York"
    }
  }
}
```

## Майбутні покращення

Потенційні покращення:
- UI відкликання сесій (відкликати конкретні сесії)
- Обмеження сесій (макс одночасні сесії на користувача)
- Більш детальні дозволи сесій
- Локальна база даних геолокації (зменшити залежність від зовнішнього API)
- Журнали активності сесій
- Підтримка багатофакторної аутентифікації
