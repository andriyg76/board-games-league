# План імплементації: Налаштування ігор з вибором гравців

## 📋 Загальний огляд

### Функціональність
Wizard для створення ігрового раунду з інтелектуальним вибором гравців на основі історії спільних ігор.

### Ключові особливості
- Двопанельний інтерфейс вибору гравців
- Кеш "останніх гравців" на сервері (в `LeagueMembership`)
- Автозаповнення слотів на основі історії
- Створення віртуальних гравців "на льоту" (через існуючий API інвайтів)
- Двоетапний wizard (вибір → налаштування)

---

## 🎯 Вимоги

| # | Питання | Рішення |
|---|---------|---------|
| 1 | Джерело гравців | Члени ліги + віртуальні гравці |
| 2 | "Останні гравці" | Сортування за датою останньої спільної гри, топ-10 |
| 3a | Початкові слоти | Кількість = розмір кешу (min ≤ slots ≤ max) |
| 3b | Динамічні слоти | Так, можна додавати/видаляти |
| 3c | Автозаповнення | До max_players з кешу |
| 4/10 | Поточний гравець | Якщо є membership → додати; якщо ні → запитати створити |
| 10a | Видалити себе | Так, можна |
| 10b | Хто може створювати | Члени ліги + суперадмін |
| 5 | Кешування | На сервері, оновлювати по закінченню раунду |
| 6 | UI | Двопанельний інтерфейс |
| 7 | Віртуальні гравці | Використовувати існуючий endpoint інвайтів |
| 8 | Де кеш | На сервері (в LeagueMembership) |
| 9 | API | `GET /api/leagues/{code}/suggested-players` |
| 11 | Структура кешу | В `LeagueMembership.recent_co_players` |
| 12 | Інвайт віртуального | Toast + копіювання в буфер + сповіщення в лізі |
| 13 | Flow | Двоетапний wizard |
| 14 | Мінімум гравців | Попередження, але дозволити продовжити |

---

## 🏗️ Архітектура

### Зміни в моделях (Backend)

#### 1. `LeagueMembership` - додати нові поля

```go
type RecentCoPlayer struct {
    MembershipID primitive.ObjectID `bson:"membership_id"`
    LastPlayedAt time.Time          `bson:"last_played_at"`
}

type LeagueMembership struct {
    // ... existing fields ...
    RecentCoPlayers []RecentCoPlayer `bson:"recent_co_players,omitempty"` // max 10 items
    LastActivityAt  time.Time        `bson:"last_activity_at,omitempty"` // дата останньої активності
}
```

#### Коли оновлювати `LastActivityAt`:

| Подія | Оновити для |
|-------|-------------|
| Створення іменованого інвайту | Нового pending membership (`time.Now()`) |
| Фіналізація гри | Всіх учасників гри (`time.Now()`) |

### API endpoints

| Method | Endpoint | Опис | Статус |
|--------|----------|------|--------|
| GET | `/api/leagues/{code}/suggested-players` | Рекомендовані гравці для раунду | **НОВИЙ** |
| POST | `/api/leagues/{code}/invitations` | Створити запрошення (+ віртуального гравця) | **Існуючий** (розширити) |

### Використання існуючого endpoint інвайтів

Endpoint `POST /api/leagues/{code}/invitations` вже реалізує:
- ✅ Приймає `{ "alias": "string" }`
- ✅ Перевірка унікальності alias серед членів ліги та активних інвайтів
- ✅ Створює `LeagueMembership` зі статусом `pending`
- ✅ Створює `LeagueInvitation` з токеном
- ✅ Повертає invitation з токеном для посилання

**Потрібно додати:**
- 🔧 Оновлення кешу `recent_co_players` поточного користувача (додати нового гравця на **останнє** місце)

### Структура відповіді `suggested-players`

```json
{
  "current_player": {
    "membership_id": "...",
    "alias": "...",
    "avatar": "...",
    "is_member": true
  },
  "recent_players": [
    {
      "membership_id": "...",
      "alias": "...",
      "avatar": "...",
      "last_played_at": "2026-01-10T...",
      "is_virtual": false
    }
  ],
  "other_players": [
    {
      "membership_id": "...",
      "alias": "...",
      "avatar": "...",
      "is_virtual": true
    }
  ]
}
```

---

## 📝 Детальний план задач

### Фаза 1: Backend - Модель та репозиторій (2-3 дні)

#### 1.1 Оновити модель `LeagueMembership`
- [ ] Додати структуру `RecentCoPlayer`
- [ ] Додати поле `RecentCoPlayers []RecentCoPlayer` (max 10)
- [ ] Додати поле `LastActivityAt time.Time`
- [ ] Міграція не потрібна - пусті значення обробляються в сортуванні (NULLS LAST)

#### 1.2 Оновити `LeagueMembershipRepository`
- [ ] Метод `UpdateRecentCoPlayers(ctx, membershipID, coPlayers []RecentCoPlayer)`
- [ ] Метод `AddRecentCoPlayer(ctx, membershipID, coPlayerMembershipID)` - додає на останнє місце
- [ ] Метод `GetMembershipWithRecentPlayers(ctx, leagueID, userID)`
- [ ] Метод `UpdateLastActivity(ctx, membershipID, timestamp)` - оновлює `last_activity_at`
- [ ] Метод `FindByLeagueSortedByActivity(ctx, leagueID, limit)` - для `other_players`

#### 1.3 Сервіс оновлення при фіналізації раунду
- [ ] Створити функцію `UpdatePlayersAfterGame(ctx, gameRound)` 
- [ ] Викликати при фіналізації раунду (`finalizeGameRound`)
- [ ] Логіка для кожного гравця раунду:
  1. Оновити `last_activity_at = now`
  2. Оновити `recent_co_players`:
     - Додати всіх інших гравців раунду з `last_played_at = now`
     - Якщо гравець вже є в списку - оновити `last_played_at`
     - Тримати max 10 записів, сортованих за `last_played_at` desc

---

### Фаза 2: Backend - API endpoints (1-2 дні)

#### 2.1 Новий endpoint `GET /api/leagues/{code}/suggested-players`
- [ ] Перевірка прав: член ліги АБО суперадмін
- [ ] Отримати поточного користувача та його membership (якщо є)
- [ ] Отримати `recent_co_players` з membership поточного користувача
- [ ] Отримати інших членів ліги (excluding current + recent), сортованих за `last_activity_at DESC`
- [ ] Сформувати відповідь з трьома секціями:

**Для члена ліги:**
| Секція | Джерело | Ліміт | Сортування |
|--------|---------|-------|------------|
| `current_player` | membership поточного користувача | 1 | - |
| `recent_players` | `recent_co_players` з membership | до 10 | `last_played_at` DESC |
| `other_players` | решта членів ліги | до 10 | `last_activity_at` DESC NULLS LAST |

**Для суперадміна без membership:**
| Секція | Джерело | Ліміт | Сортування |
|--------|---------|-------|------------|
| `current_player` | null | - | - |
| `recent_players` | пусто | 0 | - |
| `other_players` | всі члени ліги | до **20** | `last_activity_at` DESC NULLS LAST |

#### 2.2 Розширити існуючий `POST /api/leagues/{code}/invitations`
- [ ] Встановити `last_activity_at = now` для нового pending membership
- [ ] Після створення invitation додати нового гравця в кеш `recent_co_players` поточного користувача
- [ ] Додавати на **останнє** місце в кеші
- [ ] Якщо кеш повний (10 записів) - видалити найстаріший запис

#### 2.3 Оновити права доступу
- [ ] Створення раунду: член ліги АБО суперадмін
- [ ] Додати middleware перевірку

---

### Фаза 3: Frontend - API клієнт (0.5 дня)

#### 3.1 Оновити `LeagueApi.ts`
- [ ] `getSuggestedPlayers(leagueCode: string): Promise<SuggestedPlayersResponse>`
- [ ] Використати існуючий `createInvitation()` для створення віртуальних гравців

#### 3.2 Типи TypeScript
```typescript
interface SuggestedPlayer {
  membership_id: string;
  alias: string;
  avatar?: string;
  last_played_at?: string;
  is_virtual: boolean;
}

interface SuggestedPlayersResponse {
  current_player: SuggestedPlayer | null;
  recent_players: SuggestedPlayer[];
  other_players: SuggestedPlayer[];
}
```

---

### Фаза 4: Frontend - UI компоненти (3-4 дні)

#### 4.1 Компонент `PlayerSelector.vue` (двопанельний)
- [ ] Ліва панель: "Доступні гравці"
  - **Єдиний список** (recent + other змішані за пріоритетом)
  - Пошук/фільтр
  - Кнопка "Додати" біля кожного гравця
- [ ] Права панель: "Обрані гравці"
  - Список обраних
  - Кнопка "Видалити" біля кожного
  - **Можливість виділити одного гравця** (клік) - для призначення модератором
  - Поточний гравець позначений (якщо є)
- [ ] Індикатор `min_players` / `max_players`
- [ ] Попередження якщо менше `min_players`
- [ ] **Виділений гравець** → передається як модератор на наступний крок (для ігор з модератором)

#### 4.2 Компонент `CreateVirtualPlayerDialog.vue`
- [ ] Поле вводу alias
- [ ] Перевірка унікальності (debounced) - через існуючу валідацію
- [ ] Кнопка "Створити"
- [ ] Використовує існуючий `POST /api/leagues/{code}/invitations`
- [ ] При успіху: toast + копіювання посилання в буфер
- [ ] Автоматично додати до списку обраних

#### 4.3 Оновити `GameroundEdit.vue` → Wizard
- [ ] **Крок 1**: Вибір типу гри
  - Список типів ігор
  - Після вибору → перехід до кроку 2
- [ ] **Крок 2**: Вибір гравців (`PlayerSelector`)
  - Автозаповнення на основі `suggested-players`
  - Можливість виділити гравця для модератора
  - Кнопка "Далі"
- [ ] **Крок 3**: Налаштування раунду
  - Назва раунду
  - Призначення команд (якщо є)
  - Модератор = виділений гравець з кроку 2 (для ігор з модератором)
  - Кнопка "Зберегти"

#### 4.4 Логіка автозаповнення
```typescript
function autoFillPlayers(gameType: GameType, suggestedPlayers: SuggestedPlayersResponse) {
  const selected: SuggestedPlayer[] = [];
  const maxSlots = gameType.max_players;
  
  // 1. Додати поточного гравця (якщо є membership)
  if (suggestedPlayers.current_player) {
    selected.push(suggestedPlayers.current_player);
  }
  
  // 2. Заповнити з recent_players
  for (const player of suggestedPlayers.recent_players) {
    if (selected.length >= maxSlots) break;
    if (!selected.find(p => p.membership_id === player.membership_id)) {
      selected.push(player);
    }
  }
  
  // 3. Заповнити з other_players якщо ще є місце
  for (const player of suggestedPlayers.other_players) {
    if (selected.length >= maxSlots) break;
    if (!selected.find(p => p.membership_id === player.membership_id)) {
      selected.push(player);
    }
  }
  
  return selected;
}
```

---

### Фаза 5: Інтеграція та тестування (2 дні)

#### 5.1 Backend тести
- [ ] Тест оновлення кешу при фіналізації
- [ ] Тест endpoint `suggested-players`
- [ ] Тест оновлення кешу при створенні інвайту
- [ ] Тест перевірки прав доступу

#### 5.2 Frontend тести
- [ ] Тест автозаповнення
- [ ] Тест wizard flow
- [ ] Тест створення віртуального гравця через інвайт

#### 5.3 E2E сценарії
- [ ] Новий користувач без історії
- [ ] Користувач з історією ігор
- [ ] Суперадмін без membership
- [ ] Створення віртуального гравця

---

## 🔄 Діаграма потоку даних

```
┌─────────────────────────────────────────────────────────────┐
│                    Створення раунду                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    КРОК 1: Вибір типу гри                    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🎲 Мафія              [4-10 гравців, з модератором]│    │
│  │  🎯 Кодові імена       [4-8 гравців, команди]       │    │
│  │  🃏 Покер              [2-6 гравців]                │    │
│  │  ...                                                │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│                                          [Далі →]            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  GET /api/leagues/{code}/suggested-players                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 1. Перевірка прав (член ліги / суперадмін)           │   │
│  │ 2. Отримати membership поточного користувача          │   │
│  │ 3. Отримати recent_co_players з кешу                  │   │
│  │ 4. Отримати інших членів ліги (за last_activity_at)   │   │
│  │ 5. Сформувати відповідь                               │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    КРОК 2: Вибір гравців                     │
│  ┌─────────────────────┐    ┌─────────────────────┐         │
│  │   Доступні гравці   │    │   Обрані гравці     │         │
│  │   ───────────────   │    │   ─────────────     │         │
│  │   • Player A    [+] │ ←→ │   • Гравець 1  [x]  │         │
│  │   • Player B    [+] │    │   • Гравець 2  [x]  │ ← виділений (модератор) │
│  │   • Player C    [+] │    │   • ...             │         │
│  │   • Player D    [+] │    │                     │         │
│  │   ...               │    │   [+ Віртуальний]   │         │
│  └─────────────────────┘    └─────────────────────┘         │
│                                                              │
│  🔍 [Пошук...]          min: 4 / обрано: 5 / max: 6         │
│                                                              │
│  💡 Клікніть на гравця справа щоб призначити модератором    │
│                              [← Назад]  [Далі →]             │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┴─────────────────────┐
        │ [+ Віртуальний] натиснуто                 │
        ▼                                           │
┌───────────────────────────────┐                   │
│  POST /api/leagues/{code}/    │                   │
│       invitations             │                   │
│  ┌─────────────────────────┐  │                   │
│  │ { "alias": "Новий" }    │  │                   │
│  │ → Створити membership   │  │                   │
│  │ → Створити invitation   │  │                   │
│  │ → Оновити last_activity │  │                   │
│  │ → Оновити кеш (останнє) │  │                   │
│  │ → Повернути token       │  │                   │
│  └─────────────────────────┘  │                   │
│  Response: invitation + link  │                   │
└───────────────────────────────┘                   │
        │                                           │
        │ Toast: "Посилання скопійовано!"           │
        │ Додати гравця до обраних                  │
        └─────────────────────────────────────────→─┤
                                                    │
                              ┌─────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    КРОК 3: Налаштування                      │
│                                                              │
│  Назва раунду: [___________________]                         │
│                                                              │
│  Гравці:                                                     │
│  ┌────────────────┬──────────────┬────────────────┐         │
│  │ Гравець        │ Команда      │ Модератор      │         │
│  ├────────────────┼──────────────┼────────────────┤         │
│  │ Player A       │ [Команда 1▼] │ [ ]            │         │
│  │ Player B       │ [Команда 2▼] │ [✓] ← з кроку 2│         │
│  │ ...            │ ...          │ ...            │         │
│  └────────────────┴──────────────┴────────────────┘         │
│                                                              │
│                              [← Назад]  [Зберегти]           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Фіналізація раунду (пізніше)                    │
│  ───────────────────────────────────────                     │
│  При фіналізації → оновити last_activity_at та              │
│  recent_co_players для всіх учасників раунду                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 📅 Орієнтовний таймлайн

| Фаза | Опис | Тривалість |
|------|------|------------|
| 1 | Backend: Модель та репозиторій | 2-3 дні |
| 2 | Backend: API endpoints | 1-2 дні |
| 3 | Frontend: API клієнт | 0.5 дня |
| 4 | Frontend: UI компоненти | 3-4 дні |
| 5 | Інтеграція та тестування | 2 дні |
| **Всього** | | **8.5-11.5 днів** |

---

## ⚠️ Важливі примітки

1. **Міграція не потрібна**: 
   - Пусті `recent_co_players` заповняться автоматично при фіналізації нових раундів
   - Пусті `last_activity_at` сортуються в кінець списку (NULLS LAST)

2. **Суперадмін**: Може створювати раунди без membership, але не буде автоматично доданий до списку гравців.

3. **Віртуальні гравці**: При створенні через інвайт одразу додаються в кеш `recent_co_players` поточного користувача на **останнє місце**. Якщо кеш повний - видаляється найстаріший запис.

4. **Інвайт**: Використовує **існуючу** функціональність `POST /api/leagues/{code}/invitations`, розширену оновленням кешу.

5. **Перевірка унікальності**: Існуючий endpoint вже перевіряє унікальність alias серед:
   - Активних членів ліги
   - Pending членів (активні інвайти)
   - Віртуальних членів

---

## 🔗 Пов'язані файли

### Backend
- `backend/models/league_membership.go` - модель membership
- `backend/repositories/league_membership_repository.go` - репозиторій
- `backend/services/league_service.go` - сервіс ліг (CreateInvitation)
- `backend/gameapi/league.go` - API handlers інвайтів
- `backend/gameapi/gameround.go` - логіка раундів

### Frontend
- `frontend/src/gametypes/GameroundEdit.vue` - поточний компонент редагування
- `frontend/src/api/LeagueApi.ts` - API клієнт ліг
- `frontend/src/api/GameApi.ts` - API клієнт ігор
- `frontend/src/store/player.ts` - store гравців
